#
# This is a project Makefile. It is assumed the directory this Makefile resides in is a
# project subdirectory.
#

PROJECT_PATH := $(abspath .)
PROJECT_NAME :=  $(notdir $(PROJECT_PATH))
PROJECT_BOARD := evb
export PROJECT_PATH PROJECT_BOARD
#CONFIG_TOOLPREFIX :=

BLECONTROLLER_LIBS := std m0s1 m0s1s m0s1p m16s1 m0s0sp
BLECONTROLLER_LIB_DEFAULT := std
BLECONTROLLER_LIB_PREFIX := blecontroller_702_

-include ./proj_config.mk

ifeq ($(origin BL60X_SDK_PATH), undefined)
BL60X_SDK_PATH_GUESS ?= $(shell pwd)
BL60X_SDK_PATH ?= $(BL60X_SDK_PATH_GUESS)/../..
$(info ****** Please SET BL70X_SDK_PATH ******)
$(info ****** Trying SDK PATH [$(BL60X_SDK_PATH)])
endif

INCLUDE_COMPONENTS += bl702 bl702_std newlibc bl702_rf hosal vfs yloop utils cli blog
INCLUDE_COMPONENTS += blmtd blfdt
INCLUDE_COMPONENTS += easyflash4 coredump mbedtls_lts
INCLUDE_COMPONENTS += lmac154

ifeq ($(CONFIG_USB_CDC), 1)
INCLUDE_COMPONENTS += bl702_usb_cdc
endif

ifeq ($(CONFIG_USE_PSRAM), 1)
CPPFLAGS += -DCFG_USE_PSRAM=1
endif

ifneq ($(origin CONFIG_USB_CDC_VID), undefined)
CPPFLAGS += -DCFG_USB_CDC_VID=$(CONFIG_USB_CDC_VID)
endif

ifneq ($(origin CONFIG_USB_CDC_PID), undefined)
CPPFLAGS += -DCFG_USB_CDC_PID=$(CONFIG_USB_CDC_PID)
endif

ifeq ($(CONFIG_BT),1)
ifeq ($(CONFIG_BLECONTROLLER_LIB),all)
    INCLUDE_COMPONENTS += $(addprefix $(BLECONTROLLER_LIB_PREFIX), $(BLECONTROLLER_LIBS))
else
    ifeq ($(findstring $(CONFIG_BLECONTROLLER_LIB), $(BLECONTROLLER_LIBS)),)
        INCLUDE_COMPONENTS += $(addprefix $(BLECONTROLLER_LIB_PREFIX), $(BLECONTROLLER_LIB_DEFAULT))
    else
        INCLUDE_COMPONENTS += $(addprefix $(BLECONTROLLER_LIB_PREFIX), $(CONFIG_BLECONTROLLER_LIB))
    endif
endif
INCLUDE_COMPONENTS += blestack
endif

ifeq ($(CONFIG_GEN_ROM),1)
    INCLUDE_COMPONENTS += bl702_freertos_rom
else
    ifeq ($(CONFIG_BUILD_ROM_CODE),1)
        INCLUDE_COMPONENTS += bl702_freertos
    else
        INCLUDE_COMPONENTS += bl702_freertos_rom
    endif
endif

ifeq ($(CONFIG_BT),1)
INCLUDE_COMPONENTS += blestack blecontroller
endif

INCLUDE_COMPONENTS += openthread_port openthread_utils_bl702 openthread
INCLUDE_COMPONENTS += $(PROJECT_NAME)

CPPFLAGS += -DCFG_CPP_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_PLATFORM_INFO=\"BL702\"

CPPFLAGS += -DOPENTHREAD_CONFIG_HEAP_EXTERNAL_ENABLE=1

#CPPFLAGS += -DOPENTHREAD_CONFIG_LOG_MAC=1
CPPFLAGS += -DOPENTHREAD_CONFIG_LOG_SUFFIX=\"\\r\\n\"

OPENTHREAD_RADIO := 0
ifeq ($(origin CONFIG_NCP), undefined)
    CPPFLAGS += -DOPENTHREAD_RADIO=0
    ifeq ($(CONFIG_FTD), 1)
        CPPFLAGS += -DOPENTHREAD_FTD=1
        CPPFLAGS += -DOPENTHREAD_MTD=0
    else
        CPPFLAGS += -DOPENTHREAD_FTD=0
        CPPFLAGS += -DOPENTHREAD_MTD=1

        CPPFLAGS += -DCONFIG_PP=${CONFIG_PP}
    endif

    CPPFLAGS += -DCONFIG_PREFIX=${CONFIG_PREFIX}

    ifeq ($(origin CONFIG_OTDEMO), undefined)
        #only cli command image
        ifeq ($(CONFIG_FTD), 1)
            # only build image with joiner and commissioner configuration for FTD device
            CPPFLAGS += -DOPENTHREAD_CONFIG_COMMISSIONER_ENABLE=1
            CPPFLAGS += -DOPENTHREAD_CONFIG_JOINER_ENABLE=1
        else
            # only build image with joiner configuration for MTD device
            CPPFLAGS += -DOPENTHREAD_CONFIG_JOINER_ENABLE=1
        endif
    else
        CPPFLAGS += -DCONFIG_OTDEMO=${CONFIG_OTDEMO}
        ifeq (${CONFIG_OTDEMO}, 2)
            # coap demo image
            CPPFLAGS += -DOPENTHREAD_CONFIG_COAP_API_ENABLE=1
        endif
    endif
else
    CPPFLAGS += -DCONFIG_NCP=${CONFIG_NCP}
    CPPFLAGS += -DOPENTHREAD_CONFIG_NCP_HDLC_ENABLE=1
    CPPFLAGS += -DOPENTHREAD_ENABLE_NCP_SPINEL_ENCRYPTER=0

    ifeq ($(CONFIG_NCP), 0)
        OPENTHREAD_RADIO:=1
        CPPFLAGS += -DOPENTHREAD_RADIO=1
        CPPFLAGS += -DOPENTHREAD_SPINEL_CONFIG_OPENTHREAD_MESSAGE_ENABLE=0
        CPPFLAGS += -DOPENTHREAD_FTD=0
        CPPFLAGS += -DOPENTHREAD_MTD=0
    else
        CPPFLAGS += -DOPENTHREAD_RADIO=0
        CPPFLAGS += -DOPENTHREAD_SPINEL_CONFIG_OPENTHREAD_MESSAGE_ENABLE=1
        ifeq ($(CONFIG_FTD), 1)
            CPPFLAGS += -DOPENTHREAD_FTD=1
            CPPFLAGS += -DOPENTHREAD_MTD=0
        else
            CPPFLAGS += -DOPENTHREAD_FTD=0
            CPPFLAGS += -DOPENTHREAD_MTD=1
        endif
    endif


endif
export OPENTHREAD_RADIO

ifeq ($(CONFIG_TIMESYNC), 1)
CPPFLAGS += -DOPENTHREAD_CONFIG_TIME_SYNC_ENABLE=1
endif

ifneq ($(CONFIG_OPENTHREAD_CONFIG_THREAD_VERSION), 2)
ifeq ($(CONFIG_LINK_METRICS), 1)
CPPFLAGS += -DOPENTHREAD_CONFIG_MLE_LINK_METRICS_SUBJECT_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_MLE_LINK_METRICS_INITIATOR_ENABLE=1
else
CPPFLAGS += -DOPENTHREAD_CONFIG_MLE_LINK_METRICS_SUBJECT_ENABLE=0
endif

ifeq ($(CONFIG_CSL_RX), 1)
CPPFLAGS += -DOPENTHREAD_CONFIG_MAC_CSL_RECEIVER_ENABLE=1
endif

CPPFLAGS += -DOPENTHREAD_CONFIG_TMF_PROXY_MLR_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_DUA_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_MLR_ENABLE=1
endif

CPPFLAGS += -DOPENTHREAD_CONFIG_IP6_FRAGMENTATION_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_TMF_NETWORK_DIAG_MTD_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_TMF_NETDATA_SERVICE_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_TMF_ANYCAST_LOCATOR_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_DATASET_UPDATER_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_COAP_BLOCKWISE_TRANSFER_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_COAP_SECURE_API_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_DHCP6_CLIENT_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_NEIGHBOR_DISCOVERY_AGENT_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_COAP_API_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_IP6_SLAAC_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_ECDSA_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_SRP_CLIENT_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_SRP_CLIENT_AUTO_START_API_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_DNS_CLIENT_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_PING_SENDER_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_SNTP_CLIENT_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_REFERENCE_DEVICE_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_SRP_SERVER_ENABLE=0

CPPFLAGS += -DOPENTHREAD_CONFIG_BORDER_ROUTER_ENABLE=0
CPPFLAGS += -DOPENTHREAD_CONFIG_BACKBONE_ROUTER_ENABLE=0

CPPFLAGS += -DOPENTHREAD_CONFIG_PLATFORM_XTAL_ACCURACY=40

CPPFLAGS += -DOPENTHREAD_CONFIG_MAC_BEACON_PAYLOAD_PARSING_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_MAC_OUTGOING_BEACON_PAYLOAD_ENABLE=1

CPPFLAGS += -DOPENTHREAD_CONFIG_FILE=\"include/openthread-core-bl-config.h\"
CPPFLAGS += -DOPENTHREAD_PROJECT_CORE_CONFIG_FILE=\"include/openthread-core-bl-config.h\"
CPPFLAGS += -DOPENTHREAD_CORE_CONFIG_PLATFORM_CHECK_FILE=\"include/openthread-core-bl-config-check.h\"

ifeq ($(CONFIG_GOLDEN_UNIT), 1)
CPPFLAGS += -DOPENTHREAD_CONFIG_REFERENCE_DEVICE_ENABLE=1
CPPFLAGS += -DOPENTHREAD_CONFIG_MAC_FILTER_ENABLE=1
endif

ifdef CONFIG_OPENTHREAD_CONFIG_THREAD_VERSION
CPPFLAGS += -DCONFIG_OPENTHREAD_CONFIG_THREAD_VERSION=${CONFIG_OPENTHREAD_CONFIG_THREAD_VERSION}
endif

include $(BL60X_SDK_PATH)/make_scripts_riscv/project.mk

EXTRA_LDFLAGS += -Wl,--print-memory-usage
ifdef CONFIG_CACHE_SIZE
EXTRA_LDFLAGS += -Wl,--defsym=__CACHE_SIZE=$(CONFIG_CACHE_SIZE)
endif